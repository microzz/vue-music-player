<template>
  <div id="app">

    <!-- 头部音乐信息 -->
    <div v-bind:style="{backgroundColor: skinColor}" class="header">
      <div v-on:click="isShowAdd=!isShowAdd;isShowList=false" class="add-icon">
        <img src="http://omratag7g.bkt.clouddn.com/add.png" class="icon" alt="microzz.com">
      </div>
      <div class="music-title">
        <p>{{ musicTitle }}</p>
      </div>
      <div class="list-icon">
        <img v-on:click="isShowList=!isShowList" src="http://omratag7g.bkt.clouddn.com/Category.png" class="icon" alt="microzz.com">
      </div>
    </div>

    <!-- 音乐内容主体区域 -->
    <div v-on:click.stop.prevent="isShowList=false" class="content">

      <audio v-bind:src="musicSrc" preload >
        Your browser does not support the audio element.
      </audio>

      <!-- 音乐列表，同是设置显示、隐藏的过渡效果 -->
      <transition name="fade">
        <div class="music-list" v-show="isShowList">
          <ul>
            <li v-on:click.stop.prevent="toggleMusic(index)" v-bind:class="{ activeColor: item.src === (DOM.audio && DOM.audio.src) }" v-for="(item, index) in musics">
              <span>{{ item.name }}</span>
              <img v-on:click.stop.prevent="delMusic(index)" src="./assets/images/recycle.png" alt="microzz.com">
            </li>
          </ul>
        </div>
      </transition>

      <!-- 提示信息框 -->
      <transition name="fade">
        <div class="msg" v-if="isShowMsg">
          <img src="http://omratag7g.bkt.clouddn.com/%E6%8F%90%E7%A4%BA.png" alt="microzz.com">
          <p>{{ msg }}</p>
        </div>
      </transition>


      <div class="bg-img">
        <img v-bind:src="musicImgSrc" alt="microzz.com">
      </div>

      <div class="content-header"></div>

      <div class="img">
          <img v-bind:class="{imgAnimate: isImgAnimate}" class="rotateImg" v-bind:src="musicImgSrc" alt="microzz.com">
      </div>

      <div class="content-footer"></div>

      <!-- 换肤 -->
      <transition name="fade">
        <div v-show="isShowColor" v-on:click.capture="isShowColor=false" class="select-skin">
          <div v-on:click.stop.prevent="skinColor='#B72712'" v-bind:class="{borderStyle: ('#B72712'==skinColor)}" class="one"></div>
          <div v-on:click.stop.prevent="skinColor='#1565C0'" v-bind:class="{borderStyle: ('#1565C0'==skinColor)}" class="two"></div>
          <div v-on:click.stop.prevent="skinColor='#212121'" v-bind:class="{borderStyle: ('#212121'==skinColor)}" class="three"></div>
          <div v-on:click.stop.prevent="skinColor='#1B5E20'" v-bind:class="{borderStyle: ('#1B5E20'==skinColor)}" class="four"></div>
        </div>
      </transition>

        <img v-on:click.stop.prevent="isShowColor = !isShowColor" class="skin" v-bind:src="skinSrc" alt="microzz.com">

    </div>
    
          <!-- 添加音乐 -->
    <transition name="fade">
        <div v-show="isShowAdd" class="add-music">
        <div class="add_music_box">
            <p>添加歌曲</p>
            <div class="form">

              <div class="input-music-name input">
                <label for="musicname">歌曲名称</label>
                <input v-model.trim="newMusicName" v-on:keyup.enter="addMusic" id="musicname" type="text" placeholder="请输入要显示的歌曲名(必填)">
                <img v-on:click.stop.prevent="newMusicName=''" src="http://omratag7g.bkt.clouddn.com/del2.png" alt="microzz.com">
              </div>

              <div class="input-music-src input">
                <label for="music-src">歌曲链接</label>
                <input v-model.trim="newMusicSrc" v-on:keyup.enter="addMusic" id="music-src" type="text" placeholder="请输入歌曲超链接(必填)">
                <img v-on:click.stop.prevent="newMusicSrc=''" src="http://omratag7g.bkt.clouddn.com/del2.png" alt="microzz.com">
              </div>

              <div class="input-music-img-src input">
                <label for="music-img-src">照片链接</label>
                <input v-model.trim="newMusicImgSrc" v-on:keyup.enter="addMusic" id="music-img-src" type="text" placeholder="请输入歌曲写真照片链接">
                <img v-on:click.stop.prevent="newMusicImgSrc=''" src="http://omratag7g.bkt.clouddn.com/del2.png" alt="microzz.com">
              </div>

              <div class="input-btn input">
                <button v-on:click.stop.prevent="addMusic">添加音乐</button>
                <button v-on:click.stop.prevent="isShowAdd=false">取消操作</button>
              </div>
            </div>
        </div>
        </div>
      </transition>

    <!-- 底部控制栏  -->
    <div v-bind:style="{backgroundColor: skinColor}" class="footer">

      <div class="prev">
        <img v-on:click.stop.prevent="toggleMusic(index-1) " src="http://omratag7g.bkt.clouddn.com/music_rewind_button.png" class="icon" alt="microzz.com" :index="index">
      </div>

      <div class="start-pause">
        <img v-on:click.stop.prevent="startPause" v-bind:src="playBtnSrc" class="icon" alt="microzz.com">
      </div>

      <div class="next">
        <img v-on:click.stop.prevent="toggleMusic(index+1)" src="http://omratag7g.bkt.clouddn.com/music_fastforward_button.png" class="icon" alt="microzz.com" :index="index">
      </div>

    </div>

  </div>
</template>

<script>
// 导入音乐数据
import MusicData from './music-data';

// 导入封装的 localStorage 相关方法
import Store from './store';

export default {
  name: 'app',
  // 页面载入初始化
  mounted() {
    this.DOM = {
      audio: document.querySelector('audio'),
      rotateImg: document.querySelector('.rotateImg')
    };
    //audio.duration播放时间
    //audio.currentTime播放进度
    this.musicSrc = this.musics[this.index].src;
    this.musicTitle = this.musics[this.index].name;
    this.musicImgSrc = this.musics[this.index].musicImgSrc || this.musicSrcDefault;
    this.DOM.audio.addEventListener('ended', () => {this.toggleMusic(index+1);});
    Store.fetch('musics').length === 0 ? Store.save(this.musics) : null;

  },
  data() {
    return {
      musicTitle: '',
      playBtnSrc: 'http://omratag7g.bkt.clouddn.com/music_play_button.png',
      DOM: {},
      musicImgSrc: '',
      musics: Store.fetch('musics').length ? Store.fetch('musics') : Object.assign([], MusicData),
      index: 0,
      musicSrc: '',
      isImgAnimate: false,
      isShowList: false,
      isShowMsg: false,
      isShowColor: false,
      changeFlag: '',
      musicSrcDefault: 'http://omratag7g.bkt.clouddn.com/music-bg.jpg',
      isShowAdd: false,
      newMusicName: '',
      newMusicSrc: '',
      newMusicImgSrc: '',
      msg: '',
      skinSrc: 'http://omratag7g.bkt.clouddn.com/%E7%9A%AE%E8%82%A4%20%281%29.png',
      skinColor: localStorage.skinColor ? localStorage.skinColor: '#B72712'
    }
  },
  watch: {
    musics: {
      handler(musics) {
        Store.save(musics);
      },
      deep: true
    },
    skinColor: {
      handler(skinColor) {
        localStorage.setItem('skinColor', skinColor);
      }
    },
    isShowColor: {
      handler(isShowColor) {
        this.skinSrc = isShowColor ? 'http://omratag7g.bkt.clouddn.com/%E7%9A%AE%E8%82%A4.png' : 'http://omratag7g.bkt.clouddn.com/%E7%9A%AE%E8%82%A4%20%281%29.png';
      }
    }
  },
  methods: {
    // 显示提示信息
    showMsg(msg) {
      this.msg = msg;
      this.isShowMsg = true;
      setTimeout( () => {
        this.isShowMsg = false;
      }, 2000)
    },
    // 增加音乐
    addMusic() {
      if (!this.newMusicName || !this.newMusicSrc) {
        this.showMsg('请填写完整信息哦😜');
        return;
      }
      if (!(/^(https?).*(mp3|ogg|m4a)$/i.test(this.newMusicSrc))) {
        this.showMsg('你的音乐链接可能无效哦,请重新输入');
        return;
      }
      let newMusic = {
        name: this.newMusicName,
        src: this.newMusicSrc,
        musicImgSrc: this.newMusicImgSrc || this.musicSrcDefault
      };
      this.musics.push(newMusic);
      this.isShowAdd = false;
      this.newMusicName = '';
      this.newMusicSrc = '';
      this.newMusicImgSrc = '';
      this.showMsg('添加音乐成功😄')
    },
    // 删除音乐
    delMusic(index) {
      if (confirm('确认删除吗？')) {
        var paused = this.DOM.audio.paused;
        if(index == this.index){
          this.musics.splice(index, 1);
          if(this.musics.length!=0){
            this.toggleMusic(index);
            if(paused){this.DOM.audio.play();this.startPause();}
          }
        }else{
         index<this.index?this.index--:null;
         this.musics.splice(index, 1);
        }
        if(this.musics.length == 0){
          this.musicTitle = '没有歌曲啦 💔';
          this.DOM.audio.autoplay = false;
          this.DOM.audio.pause();
          this.isImgAnimate = false;
          this.playBtnSrc = 'http://omratag7g.bkt.clouddn.com/music_play_button.png';
          this.DOM.rotateImg.style.animationPlayState = 'paused';
          this.musicImgSrc = this.musicSrcDefault;
          this.showMsg('赶紧添加几首音乐吧😄');
          return;        
        }     
      }
      },
    // 切换音乐
    toggleMusic(index) {
      index = index < 0 ? this.musics.length-1 : index;
      index = index > this.musics.length-1 ? 0 : index;
      var item = this.musics[index];
      this.index = index;
      this.musicTitle = item.name;
      this.musicSrc = item.src;
      this.musicImgSrc = item.musicImgSrc || this.musicSrcDefault;
      this.DOM.audio.autoplay = true;
      this.DOM.audio.play();
      this.playBtnSrc = 'http://omratag7g.bkt.clouddn.com/music_pause_button.png';
      this.toAnimate();
      this.isShowList = false;
    },
    // 图片旋转
    toAnimate() {
        this.isImgAnimate = true;
        this.DOM.rotateImg.style.animationPlayState = 'running';
    },

    // 开始 or 暂停
    startPause() {
      if(this.musics.length != 0){
      this.playBtnSrc = this.DOM.audio.paused ? 'http://omratag7g.bkt.clouddn.com/music_pause_button.png' : 'http://omratag7g.bkt.clouddn.com/music_play_button.png';
      this.DOM.audio.paused ? this.DOM.audio.play() : this.DOM.audio.pause();
      this.DOM.rotateImg.style.animationPlayState = this.DOM.audio.paused ? 'paused' : 'running'
      this.isImgAnimate = true;
    }
    },
  },

  components: {}
}
</script>

<style>
#app {
  width: 100%;
  height: 100%;
  display: flex;
  position: relative;
  flex-direction: column;
}
::-webkit-scrollbar {
    width: 10px;
    background-color: rgba(0,0,0,.6);
}
 
/* Track */
::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3); 
    -webkit-border-radius: 6px;
    border-radius: 6px;
}
 
/* Handle */
::-webkit-scrollbar-thumb {
    -webkit-border-radius: 6px;
    border-radius: 6px;
    background: rgba(60,60,60,.8); 
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5); 
}
::-webkit-scrollbar-thumb:window-inactive {
  background: rgba(60,60,60,.8); 
}

.borderStyle {
  border: 1px solid #E0E0E0;
  box-shadow: 0 0 3px #FFD600;
}

.msg {
  position: absolute;
  z-index: 4;
  top: 2px;
  right: 0;
  height: 32px;
  line-height: 32px;
  padding:2px 20px 5px 35px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 3px;
}

.msg img {
  width: 18px;
  height: 18px;
  position: absolute;
  top: 9px;
  left: 10px;
}

.msg p {
  margin: auto;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: white;
}

.activeColor {
  color: #FF6E40;
}

.header {
  flex: 1;
  background-color: #212121;
  display: flex;
  align-items: center;
}

.header img {
  width: 30px;
  height: 30px;
}

.header .add-icon {
  width: 30px;
  height: 30px;
  flex: 1;
  text-align: left;
  padding-left: 10px;
  padding-top: 5px;
  cursor: pointer;
}

.header .music-title {
  flex: 5;
  text-align: center;
}

.header .list-icon {
  width: 30px;
  height: 30px;
  flex: 1;
  text-align: right;
  padding-right: 10px;
  padding-top: 5px;
}

.header .list-icon img {
  width: 23px;
  cursor: pointer;
}

.header .music-title p {
  width: 250px;
  color: white;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: auto;
}

.content {
  flex: 11;
  display: flex;
  flex-direction: column;
  position: relative;
}
.add_music_box{
    width: 350px;
    top: 50%;
    left: 50%;
    position: absolute;
    transform: translate(-50%, -50%);
    margin-top: -70px;
}
 .add-music {
  text-align: center;
  color: white;
  background-color: rgba(0, 0, 0, 0.7);
  width: 100%;
  height: 100%;
  z-index: 3;
  position: absolute;
  left: 0;
  bottom: 0;
}

 .add-music p {
  font-size: 1.5rem;
  margin-bottom: 2rem;
  margin-top: 3rem;
}

@media only screen and (min-width: 1024px) {
  .content .add-music p {
      margin-top: 6rem;
  }
}

 .add-music .form {
  /*padding-bottom: 10px;*/

}

.add-music .form img {
    width: 15px;
    position: relative;
    margin-left: -25px;
    top: 4px;
    cursor: pointer;
}

input {
    border: 1px solid #eee;
    outline: none;
    padding: 5px;
    width: 200px;
    border-radius: 3px;
    padding-right: 25px;
}
input:focus{
border: 1px solid rgba(82, 168, 236, 0.8);
outline: thin dotted \9;
box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.1), 0 0 11px rgba(82, 168, 236, 0.8);
}
label{font-size: 15px;margin-right: 5px;}

 .input-music-name {
  margin-bottom: 1.8rem;
}

 .input-music-src {
  margin-bottom: 1.8rem;
}

 .input-music-img-src {
  margin-bottom: 2rem;
}

 .input-btn {
  text-align: right;
  padding-right: 30px;
}

 .input-btn button {
    border: none;
    outline: none;
    color:#fff;
    margin: 0 10px;
    padding: 7px 12px;
    background: #427cd3;
    border:1px solid #337ff3;
    cursor: pointer;
    border-radius: 2px;
}
 .input-btn button:hover{
  background: #337ff3;
 }
 .music-list {
  position: absolute;
  z-index: 3;
  right: 0;
  top: 0;
  margin: 0;
  padding: 0;
  overflow-y: auto;
  height: 100%;
}

.content li img {
    width: 20px;
    float: right;
    margin-top: 11px;
    cursor: pointer;
}

ul {
  list-style: decimal;
  background: rgba(0, 0, 0, .7);
  margin: 0;
  padding: 2px 10px 2px 30px;
  box-shadow: 0px 0px 10px rgba(255,255,255,.3) inset; 
}
ul li{
    color: #BDBDBD;
    border-bottom: 1px solid #616161;
    line-height: 40px;
    font-size: 15px;
}
ul li:last-of-type{
  border-bottom: none;
}
ul li:after{
  content: "";
  display: block;
  clear: both;
}
ul li span{
  cursor: pointer;
  display: inline-block;
  min-width: 180px;
  margin-right: 10px;
}
ul li:hover{color: #92d0fa;}
 .bg-img img {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: 99%;
  filter: blur(8px);
  z-index: -1;
}

 .content-header {
  flex: 1;
}

 .img {
  flex: 5;
  display: flex;
}

@keyframes rotateAnimation {
  from {
    transform: rotate(0);
  }
  to {
    transform: rotate(360deg);
  }
}

 .img img {
  width: 240px;
  height: 240px;
  border-radius: 120px;
  margin: auto;
  z-index: 1;
}

.imgAnimate {
  animation: rotateAnimation 18s linear infinite;
}

.content-footer {
  flex: 1;
}

 .select-skin {
  width: 22px;
  height: 121px;
  position: absolute;
  right: 18px;
  bottom: 60px;
}

 .select-skin div {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 10px;
  cursor: pointer;
}


 .select-skin div.four {
  bottom: 95px;
  background-color: #1B5E20;
  flex: 1;
}

 .select-skin div.one {
  bottom: 65px;
  background-color: #B72712;
  flex: 1;
}
 .select-skin div.two {
  bottom: 35px;
  background-color: #1565C0;
  flex: 1;
}
.select-skin div.three {
  bottom: 5px;
  background-color: #212121;
  flex: 1;
}

 img.skin  {
  width: 40px;
  height: 40px;
  position: absolute;
  right: 10px;
  bottom: 20px;
  cursor: pointer;
}

.footer {
  flex: 1.8;
  display: flex;
  background-color: #212121;
}

.footer>.prev {
  flex: 5;
  text-align: center;
  margin: auto;
}

.footer>.start-pause {
  flex: 1;
  text-align: center;
  margin: auto;
}

.footer>.next {
  flex: 5;
  text-align: center;
  margin: auto;
}

.footer .icon {
  width: 40px;
  height: 40px;
}

.footer .icon:hover {
  cursor: pointer;
}

.fade-enter-active {
  transition: all .3s ease;
}
.fade-leave-active {
  transition: all .3s cubic-bezier(1.0, 0.5, 0.8, 1.0);
}
.fade-enter, .fade-leave-active {
  transform: translateX(10px);
  opacity: 0;
}
</style>
